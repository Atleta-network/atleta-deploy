name: Upgrade runtime Devnet

on:
  workflow_dispatch:

jobs:
  upgrade_runtime:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install system deps
      run: sudo apt-get install jq 
 
    - name: Authenticate GitHub CLI and download latest release of runtime
      env: 
        GH_TOKEN: ${{ github.token }}
      run: |
        LATEST_RUNTIME=$(gh release list --repo Atleta-network/atleta --json tagName,createdAt | jq -r '.[] | select(.tagName | startswith("release-runtime-devnet")) | .tagName')
        echo "${LATEST_RUNTIME}"
        gh release download "${LATEST_RUNTIME}" --repo Atleta-network/atleta --pattern "atleta_runtime.compact.compressed.wasm" --dir ./utils/set-code
       
    - name: Upgrade WASM
      uses: actions/setup-node@v4
      with:
        node-version: 18
    - run: |
          npm install
          node index.js ws://${{ secrets.DEVNET_HOST }}:9944 ${{ secrets.DEVNET_ALITH_PRIV_KEY }} atleta_runtime.compact.compressed.wasm
      working-directory: ./utils/set-code
